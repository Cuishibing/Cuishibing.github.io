<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link href="/css/common.css" rel="stylesheet" type="text/css" />
    <script src="/js/md5.min.js"></script>
    <script type="module">
        import { init } from "/js/include.js"
        init()
    </script>
</head>

<body>
    <include src="/header/s_header.html"></include>

    <span>
        <label>标题：</label>
        <input id="post_title" placeholder="输入标题" />

        <label>类型：</label>
        <input id="post_category" placeholder="输入类型" />
    </span>
    <div id="post_content" style="margin-top: 10px;margin-bottom:10px"></div>
    <script src="https://cdn.jsdelivr.net/npm/wangeditor@latest/dist/wangEditor.min.js"></script>

    <div>
        <button id="post_save_btn">保存</button>
    </div>
    <script type="module">
        import { req } from "/js/req.js"
        import { getToken } from "/js/token.js"
        import { Github } from "/js/github.js"

        let url = window.location.href
        let queryString = url.substr(url.indexOf("?") + 1)
        let queryParams = queryString.split("&")
        let target = ""
        let title = ""
        let category = ""
        queryParams.forEach(paramKV => {
            let keyAndValue = paramKV.split("=")
            if (keyAndValue[0] == "target") {
                target = decodeURI(keyAndValue[1])
            }
            if (keyAndValue[0] == "title") {
                title = decodeURI(keyAndValue[1])
            }
            if (keyAndValue[0] == "category") {
                category = decodeURI(keyAndValue[1])
            }
        })
        if (title) {
            document.getElementById("post_title").value = title
            document.getElementById("post_title").setAttribute("disabled", "true")
        }
        if (category) {
            document.getElementById("post_category").value = category
            document.getElementById("post_category").setAttribute("disabled", "true")
        }

        const E = window.wangEditor;
        const editor = new E("#post_content");
        editor.create();

        function loadContent(showType) {
            if (!showType) {
                showType = "rich"
            }
            if (target && target != "") {
                req(target, "GET").then(data => {
                    editor.txt.html(data.message)
                })
            }
        }
        loadContent()

        // edit_btn
        document.getElementById("post_save_btn").onclick = saveBtnOnclick
        function saveBtnOnclick(e) {
            let commitFiles = []

            let token = getToken()
            if (!token) {
                alert("密码错误！")
                throw Error("密码错误！")
            }

            let title = document.getElementById("post_title").value
            let category = document.getElementById("post_category").value

            let github = new Github("Cuishibing/Cuishibing.github.io", token)

            let path = ""
            if (target) {
                path = target
            } else {
                if (!title) {
                    alert("标题为空！")
                    throw Error("标题为空！")
                }
                path = "/posts/" + title + ".html"
            }

            path = decodeURI(path)

            commitFiles.push({
                path: path,
                content: editor.txt.html()
            })

            if (!category) {
                alert("类型为空！")
                throw Error("类型为空！")
            }

            req("/category/category.json", "GET").then(data => {
                let categories = data.categories

                let needUpdate = true
                let post_list = null
                categories.forEach(c => {
                    if (c.name == category) {
                        if (c.post_list) {
                            post_list = c.post_list
                            c.post_list.forEach(p => {
                                if (p.name == title && p.path == path) {
                                    needUpdate = false
                                }
                            })
                        }
                    }
                })

                if (needUpdate) {
                    if (!post_list) {
                        post_list = []
                        categories.push({
                            name: category,
                            post_list: post_list
                        })
                    }
                    post_list.push({
                        name: title,
                        path: path
                    })

                    commitFiles.push({
                        path: "/category/category.json",
                        content: JSON.stringify(data)
                    })
                }

                github.commitFile(commitFiles).then(data => {
                    console.info(data)
                    alert("保存成功")
                })

            })
        }
    </script>
</body>

</html>